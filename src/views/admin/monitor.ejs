<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统监控 - <%= company.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f8f9fa; }
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: fixed;
            width: 260px;
        }
        .main-content { margin-left: 260px; padding: 2rem; }
        .sidebar .nav-link { color: rgba(255, 255, 255, 0.8); padding: 0.75rem 1.5rem; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background: rgba(255, 255, 255, 0.1); }
        .metric-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            position: relative;
        }
        .metric-card .card-body { position: relative; z-index: 2; }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            opacity: 0.1;
            z-index: 1;
        }
        .metric-cpu::before { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }
        .metric-memory::before { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); }
        .metric-disk::before { background: linear-gradient(135deg, #45b7d1 0%, #96c93d 100%); }
        .metric-network::before { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .chart-container { height: 300px; position: relative; }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-offline { background: #dc3545; }
        .progress-sm { height: 8px; }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <nav class="sidebar">
        <div class="p-3 text-center border-bottom border-white-25">
            <h4 class="text-white"><i class="fas fa-shield-alt me-2"></i>管理面板</h4>
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin">
                    <i class="fas fa-tachometer-alt me-2"></i>仪表盘
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="fas fa-users me-2"></i>用户管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/monitor">
                    <i class="fas fa-chart-line me-2"></i>系统监控
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/backup">
                    <i class="fas fa-database me-2"></i>数据管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/company">
                    <i class="fas fa-building me-2"></i>公司信息
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/logs">
                    <i class="fas fa-file-alt me-2"></i>日志管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/settings">
                    <i class="fas fa-cog me-2"></i>系统设置
                </a>
            </li>
        </ul>
    </nav>

    <!-- 主要内容 -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">系统监控</h1>
                <p class="text-muted">实时监控服务器性能和资源使用情况</p>
            </div>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-2"></i>刷新
                </button>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        实时更新: 开启
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="toggleAutoRefresh(true)">开启</a></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleAutoRefresh(false)">关闭</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 系统状态概览 -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card metric-cpu">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle text-muted">CPU 使用率</h6>
                                <h2 class="card-title mb-0" id="cpu-usage">65.2%</h2>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-microchip fa-2x text-danger"></i>
                            </div>
                        </div>
                        <div class="progress progress-sm mt-3">
                            <div class="progress-bar bg-danger" id="cpu-progress" style="width: 65.2%"></div>
                        </div>
                        <small class="text-muted">平均负载: 1.2, 1.5, 1.8</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card metric-memory">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle text-muted">内存使用</h6>
                                <h2 class="card-title mb-0" id="memory-usage">4.2 GB</h2>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-memory fa-2x text-info"></i>
                            </div>
                        </div>
                        <div class="progress progress-sm mt-3">
                            <div class="progress-bar bg-info" id="memory-progress" style="width: 52.5%"></div>
                        </div>
                        <small class="text-muted">总共: 8.0 GB</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card metric-disk">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle text-muted">磁盘使用</h6>
                                <h2 class="card-title mb-0" id="disk-usage">156 GB</h2>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-hdd fa-2x text-success"></i>
                            </div>
                        </div>
                        <div class="progress progress-sm mt-3">
                            <div class="progress-bar bg-success" id="disk-progress" style="width: 78%"></div>
                        </div>
                        <small class="text-muted">总共: 200 GB</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card metric-network">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-subtitle text-muted">网络流量</h6>
                                <h2 class="card-title mb-0" id="network-usage">2.4 MB/s</h2>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-network-wired fa-2x text-warning"></i>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-arrow-up text-success"></i> 上传: 0.8 MB/s<br>
                                <i class="fas fa-arrow-down text-primary"></i> 下载: 1.6 MB/s
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 性能图表 -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>CPU & 内存使用趋势
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>网络流量监控
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="networkChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 服务状态和系统信息 -->
        <div class="row">
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-server me-2"></i>服务状态
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <span class="status-indicator status-online"></span>
                                    <strong>Web服务器</strong>
                                    <div class="text-muted small">运行时间: 15天 3小时</div>
                                </div>
                                <div class="mb-3">
                                    <span class="status-indicator status-online"></span>
                                    <strong>数据库</strong>
                                    <div class="text-muted small">连接池: 8/20</div>
                                </div>
                                <div class="mb-3">
                                    <span class="status-indicator status-warning"></span>
                                    <strong>Redis缓存</strong>
                                    <div class="text-muted small">内存使用: 756MB</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <span class="status-indicator status-online"></span>
                                    <strong>SSL证书</strong>
                                    <div class="text-muted small">有效期: 89天</div>
                                </div>
                                <div class="mb-3">
                                    <span class="status-indicator status-online"></span>
                                    <strong>备份服务</strong>
                                    <div class="text-muted small">最后备份: 2小时前</div>
                                </div>
                                <div class="mb-3">
                                    <span class="status-indicator status-offline"></span>
                                    <strong>监控服务</strong>
                                    <div class="text-muted small">需要重启</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>系统信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>操作系统</strong></td>
                                    <td>Ubuntu 22.04 LTS</td>
                                </tr>
                                <tr>
                                    <td><strong>Node.js版本</strong></td>
                                    <td id="node-version">v18.19.0</td>
                                </tr>
                                <tr>
                                    <td><strong>服务器IP</strong></td>
                                    <td>192.168.1.100</td>
                                </tr>
                                <tr>
                                    <td><strong>运行时间</strong></td>
                                    <td id="uptime">15天 3小时 24分钟</td>
                                </tr>
                                <tr>
                                    <td><strong>进程ID</strong></td>
                                    <td id="process-id">1234</td>
                                </tr>
                                <tr>
                                    <td><strong>活跃连接</strong></td>
                                    <td id="active-connections">23</td>
                                </tr>
                                <tr>
                                    <td><strong>请求总数</strong></td>
                                    <td id="total-requests">1,234,567</td>
                                </tr>
                                <tr>
                                    <td><strong>错误率</strong></td>
                                    <td><span class="badge bg-success">0.02%</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 实时日志 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-terminal me-2"></i>实时日志
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                <i class="fas fa-trash me-2"></i>清空
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="log-container" style="height: 300px; overflow-y: auto; background: #1e1e1e; color: #fff; padding: 1rem; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9rem;">
                            <div class="log-entry">[2025-01-30 14:30:15] INFO: Server started on port 3000</div>
                            <div class="log-entry">[2025-01-30 14:30:20] INFO: Database connected successfully</div>
                            <div class="log-entry">[2025-01-30 14:30:25] INFO: Redis cache initialized</div>
                            <div class="log-entry">[2025-01-30 14:32:10] INFO: User admin logged in from 192.168.1.50</div>
                            <div class="log-entry text-warning">[2025-01-30 14:35:45] WARN: High memory usage detected (85%)</div>
                            <div class="log-entry">[2025-01-30 14:40:12] INFO: Backup completed successfully</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let performanceChart, networkChart;
        let autoRefresh = true;
        let refreshInterval;

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            startAutoRefresh();
            updateSystemInfo();
        });

        // 初始化图表
        function initCharts() {
            // CPU & 内存图表
            const ctx1 = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(),
                    datasets: [{
                        label: 'CPU使用率',
                        data: generateRandomData(20, 40, 80),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4
                    }, {
                        label: '内存使用率',
                        data: generateRandomData(20, 30, 70),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // 网络流量图表
            const ctx2 = document.getElementById('networkChart').getContext('2d');
            networkChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(),
                    datasets: [{
                        label: '上传 (MB/s)',
                        data: generateRandomData(20, 0.5, 2.0),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4
                    }, {
                        label: '下载 (MB/s)',
                        data: generateRandomData(20, 1.0, 4.0),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' MB/s';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // 生成时间标签
        function generateTimeLabels() {
            const labels = [];
            const now = new Date();
            for (let i = 19; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000);
                labels.push(time.toLocaleTimeString().slice(0, 5));
            }
            return labels;
        }

        // 生成随机数据
        function generateRandomData(count, min, max) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push((Math.random() * (max - min) + min).toFixed(1));
            }
            return data;
        }

        // 更新系统信息
        function updateSystemInfo() {
            // 模拟实时数据更新
            document.getElementById('cpu-usage').textContent = (Math.random() * 40 + 40).toFixed(1) + '%';
            document.getElementById('memory-usage').textContent = (Math.random() * 2 + 3).toFixed(1) + ' GB';
            document.getElementById('disk-usage').textContent = (Math.random() * 20 + 150).toFixed(0) + ' GB';
            document.getElementById('network-usage').textContent = (Math.random() * 2 + 1).toFixed(1) + ' MB/s';
            
            // 更新进度条
            const cpuPercent = parseFloat(document.getElementById('cpu-usage').textContent);
            document.getElementById('cpu-progress').style.width = cpuPercent + '%';
            
            const memoryPercent = (parseFloat(document.getElementById('memory-usage').textContent) / 8 * 100);
            document.getElementById('memory-progress').style.width = memoryPercent + '%';
        }

        // 更新图表数据
        function updateCharts() {
            if (performanceChart && networkChart) {
                // 更新性能图表
                const cpuData = performanceChart.data.datasets[0].data;
                const memoryData = performanceChart.data.datasets[1].data;
                
                cpuData.shift();
                memoryData.shift();
                cpuData.push((Math.random() * 40 + 40).toFixed(1));
                memoryData.push((Math.random() * 40 + 30).toFixed(1));
                
                performanceChart.data.labels.shift();
                performanceChart.data.labels.push(new Date().toLocaleTimeString().slice(0, 5));
                performanceChart.update('none');

                // 更新网络图表
                const uploadData = networkChart.data.datasets[0].data;
                const downloadData = networkChart.data.datasets[1].data;
                
                uploadData.shift();
                downloadData.shift();
                uploadData.push((Math.random() * 1.5 + 0.5).toFixed(1));
                downloadData.push((Math.random() * 3 + 1).toFixed(1));
                
                networkChart.data.labels.shift();
                networkChart.data.labels.push(new Date().toLocaleTimeString().slice(0, 5));
                networkChart.update('none');
            }
        }

        // 添加日志条目
        function addLogEntry(message, level = 'INFO') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleString();
            const levelClass = level === 'WARN' ? 'text-warning' : level === 'ERROR' ? 'text-danger' : '';
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${levelClass}`;
            logEntry.textContent = `[${timestamp}] ${level}: ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 限制日志条目数量
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                entries[0].remove();
            }
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            addLogEntry('日志已清空');
        }

        // 刷新数据
        function refreshData() {
            updateSystemInfo();
            updateCharts();
            addLogEntry('系统数据已刷新');
        }

        // 切换自动刷新
        function toggleAutoRefresh(enable) {
            autoRefresh = enable;
            if (enable) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
            
            const button = document.querySelector('.btn-group .dropdown-toggle');
            button.textContent = `实时更新: ${enable ? '开启' : '关闭'}`;
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (autoRefresh) {
                    updateSystemInfo();
                    updateCharts();
                    
                    // 随机添加日志
                    if (Math.random() < 0.3) {
                        const messages = [
                            'API请求处理完成',
                            '用户会话清理',
                            '缓存刷新',
                            '数据库查询优化',
                            '静态资源压缩'
                        ];
                        addLogEntry(messages[Math.floor(Math.random() * messages.length)]);
                    }
                }
            }, 5000);
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
    </script>
</body>
</html> 