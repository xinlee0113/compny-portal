<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .search-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .search-form {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
        }
        .product-grid {
            min-height: 400px;
        }
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .highlight {
            background-color: #fff3cd;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .search-stats {
            margin-bottom: 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .clear-search {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">公司门户网站</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link <%= page === 'home' ? 'active' : '' %>" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= page === 'about' ? 'active' : '' %>" href="/about">公司介绍</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= page === 'products' ? 'active' : '' %>" href="/products">产品展示</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= page === 'news' ? 'active' : '' %>" href="/news">新闻动态</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= page === 'contact' ? 'active' : '' %>" href="/contact">联系我们</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 搜索区域 -->
    <div class="search-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h1 class="text-center mb-4">产品展示</h1>
                    <div class="search-form">
                        <form id="searchForm" class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="searchInput" 
                                        placeholder="搜索产品..." 
                                        value="<%= currentQuery || '' %>"
                                    >
                                    <button type="button" class="btn btn-outline-light clear-search" id="clearSearch">
                                        清除
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="categoryFilter">
                                    <option value="">所有分类</option>
                                    <% if (typeof categories !== 'undefined') { %>
                                        <% categories.forEach(category => { %>
                                            <option value="<%= category %>" <%= currentCategory === category ? 'selected' : '' %>>
                                                <%= category %>
                                            </option>
                                        <% }); %>
                                    <% } %>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sortFilter">
                                    <option value="relevance" <%= currentSort === 'relevance' ? 'selected' : '' %>>相关度</option>
                                    <option value="name" <%= currentSort === 'name' ? 'selected' : '' %>>名称排序</option>
                                    <option value="date" <%= currentSort === 'date' ? 'selected' : '' %>>最新发布</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 面包屑导航 -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">首页</a></li>
                <li class="breadcrumb-item active" aria-current="page">产品展示</li>
            </ol>
        </nav>

        <!-- 搜索统计 -->
        <div class="search-stats" id="searchStats">
            <% if (hasSearchResults) { %>
                显示 <%= products.length %> 个搜索结果
                <% if (currentQuery) { %>
                    - 关键词："<%= currentQuery %>"
                <% } %>
                <% if (currentCategory) { %>
                    - 分类：<%= currentCategory %>
                <% } %>
            <% } else { %>
                显示所有产品 (<%= products.length %> 个)
            <% } %>
        </div>

        <!-- 加载状态 -->
        <div class="loading" id="loadingState">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">搜索中...</span>
            </div>
            <p class="mt-2">正在搜索产品...</p>
        </div>

        <!-- 产品展示区域 -->
        <div class="product-grid" id="productGrid">
            <div class="row" id="productContainer">
                <% if (products && products.length > 0) { %>
                    <% products.forEach(product => { %>
                        <div class="col-lg-4 col-md-6 mb-4 product-item" data-category="<%= product.category %>">
                            <div class="card product-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title product-name"><%= product.name %></h5>
                                    <p class="card-text product-description"><%= product.description %></p>
                                    <div class="product-features">
                                        <h6>主要特性：</h6>
                                        <ul class="list-unstyled">
                                            <% product.features.forEach(feature => { %>
                                                <li class="product-feature">
                                                    <i class="text-primary">•</i> <%= feature %>
                                                </li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                    <div class="product-meta">
                                        <span class="badge bg-secondary product-category"><%= product.category %></span>
                                        <% product.tags.forEach(tag => { %>
                                            <span class="badge bg-light text-dark product-tag"><%= tag %></span>
                                        <% }); %>
                                    </div>
                                    <div class="mt-3">
                                        <a href="#" class="btn btn-primary">了解更多</a>
                                        <% if (product.relevanceScore && product.relevanceScore > 1) { %>
                                            <small class="text-muted ms-2">相关度: <%= Math.round(product.relevanceScore) %></small>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="col-12">
                        <div class="no-results" id="noResults">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <h4>未找到相关产品</h4>
                            <p>请尝试其他搜索条件或浏览所有产品分类</p>
                            <button type="button" class="btn btn-outline-primary" onclick="clearAllFilters()">
                                清除所有筛选条件
                            </button>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p>&copy; 2025 公司名称. 保留所有权利.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 产品搜索功能
        class ProductSearch {
            constructor() {
                this.searchInput = document.getElementById('searchInput');
                this.categoryFilter = document.getElementById('categoryFilter');
                this.sortFilter = document.getElementById('sortFilter');
                this.clearSearchBtn = document.getElementById('clearSearch');
                this.productContainer = document.getElementById('productContainer');
                this.loadingState = document.getElementById('loadingState');
                this.searchStats = document.getElementById('searchStats');
                
                this.searchTimeout = null;
                this.lastSearchParams = '';
                
                this.initEventListeners();
            }

            initEventListeners() {
                // 搜索输入防抖
                this.searchInput.addEventListener('input', () => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.performSearch();
                    }, 300);
                });

                // 分类和排序筛选
                this.categoryFilter.addEventListener('change', () => this.performSearch());
                this.sortFilter.addEventListener('change', () => this.performSearch());

                // 清除搜索
                this.clearSearchBtn.addEventListener('click', () => this.clearSearch());

                // 回车键搜索
                this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.performSearch();
                    }
                });
            }

            async performSearch() {
                const query = this.searchInput.value.trim();
                const category = this.categoryFilter.value;
                const sort = this.sortFilter.value;

                // 构建搜索参数
                const searchParams = new URLSearchParams();
                if (query) searchParams.set('q', query);
                if (category) searchParams.set('category', category);
                if (sort && sort !== 'relevance') searchParams.set('sort', sort);

                const currentParams = searchParams.toString();
                
                // 避免重复搜索
                if (currentParams === this.lastSearchParams) {
                    return;
                }
                this.lastSearchParams = currentParams;

                // 显示加载状态
                this.showLoading();

                try {
                    // 构建API URL
                    const apiUrl = `/api/products/search?${searchParams.toString()}`;
                    
                    // 发送搜索请求
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (data.success) {
                        this.displayResults(data.data, data.query);
                        this.updateURL(searchParams);
                    } else {
                        throw new Error(data.message || '搜索失败');
                    }
                } catch (error) {
                    console.error('搜索错误:', error);
                    this.showError('搜索过程中发生错误，请稍后重试');
                } finally {
                    this.hideLoading();
                }
            }

            displayResults(products, queryInfo) {
                this.productContainer.innerHTML = '';

                if (products.length === 0) {
                    this.showNoResults(queryInfo);
                    return;
                }

                // 更新搜索统计
                this.updateSearchStats(products.length, queryInfo);

                // 渲染产品卡片
                products.forEach(product => {
                    const productCard = this.createProductCard(product, queryInfo.keyword);
                    this.productContainer.appendChild(productCard);
                });
            }

            createProductCard(product, searchKeyword) {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-4 product-item';
                col.setAttribute('data-category', product.category);

                // 高亮搜索关键词
                const highlightText = (text, keyword) => {
                    if (!keyword) return text;
                    const regex = new RegExp(`(${keyword})`, 'gi');
                    return text.replace(regex, '<span class="highlight">$1</span>');
                };

                const relevanceScore = product.relevanceScore > 1 ? 
                    `<small class="text-muted ms-2">相关度: ${Math.round(product.relevanceScore)}</small>` : '';

                col.innerHTML = `
                    <div class="card product-card h-100">
                        <div class="card-body">
                            <h5 class="card-title product-name">${highlightText(product.name, searchKeyword)}</h5>
                            <p class="card-text product-description">${highlightText(product.description, searchKeyword)}</p>
                            <div class="product-features">
                                <h6>主要特性：</h6>
                                <ul class="list-unstyled">
                                    ${product.features.map(feature => 
                                        `<li class="product-feature">
                                            <i class="text-primary">•</i> ${highlightText(feature, searchKeyword)}
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                            <div class="product-meta">
                                <span class="badge bg-secondary product-category">${product.category}</span>
                                ${product.tags.map(tag => 
                                    `<span class="badge bg-light text-dark product-tag">${highlightText(tag, searchKeyword)}</span>`
                                ).join('')}
                            </div>
                            <div class="mt-3">
                                <a href="#" class="btn btn-primary">了解更多</a>
                                ${relevanceScore}
                            </div>
                        </div>
                    </div>
                `;

                return col;
            }

            showNoResults(queryInfo) {
                this.productContainer.innerHTML = `
                    <div class="col-12">
                        <div class="no-results">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <h4>未找到相关产品</h4>
                            <p>请尝试其他搜索条件或浏览所有产品分类</p>
                            <button type="button" class="btn btn-outline-primary" onclick="productSearch.clearAllFilters()">
                                清除所有筛选条件
                            </button>
                        </div>
                    </div>
                `;
                this.updateSearchStats(0, queryInfo);
            }

            updateSearchStats(count, queryInfo) {
                let statsText = `显示 ${count} 个搜索结果`;
                if (queryInfo.keyword) {
                    statsText += ` - 关键词："${queryInfo.keyword}"`;
                }
                if (queryInfo.category) {
                    statsText += ` - 分类：${queryInfo.category}`;
                }
                this.searchStats.textContent = statsText;
            }

            showLoading() {
                this.loadingState.style.display = 'block';
                this.productContainer.style.opacity = '0.5';
            }

            hideLoading() {
                this.loadingState.style.display = 'none';
                this.productContainer.style.opacity = '1';
            }

            showError(message) {
                this.productContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger text-center">
                            <h5>搜索出错</h5>
                            <p>${message}</p>
                            <button type="button" class="btn btn-outline-danger" onclick="location.reload()">
                                刷新页面
                            </button>
                        </div>
                    </div>
                `;
            }

            clearSearch() {
                this.searchInput.value = '';
                this.performSearch();
            }

            clearAllFilters() {
                this.searchInput.value = '';
                this.categoryFilter.value = '';
                this.sortFilter.value = 'relevance';
                this.performSearch();
            }

            updateURL(searchParams) {
                const newUrl = window.location.pathname + 
                    (searchParams.toString() ? '?' + searchParams.toString() : '');
                window.history.replaceState({}, '', newUrl);
            }
        }

        // 全局函数
        function clearAllFilters() {
            if (window.productSearch) {
                window.productSearch.clearAllFilters();
            }
        }

        // 初始化搜索功能
        document.addEventListener('DOMContentLoaded', function() {
            window.productSearch = new ProductSearch();
        });
    </script>
</body>
</html>