<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= texts.products.title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
        }
        .search-form {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
        }
        .product-grid {
            min-height: 400px;
        }
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .product-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            border-radius: 12px;
        }
        .search-stats {
            margin-bottom: 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .clear-search {
            margin-left: 10px;
        }
        
        /* 车载产品专用样式 */
        .feature-list li {
            margin-bottom: 0.3rem;
            font-size: 0.85rem;
        }
        
        .platform-tags .badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        
        .specifications {
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
        }
        
        .tag-container {
            max-height: 2.5rem;
            overflow: hidden;
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
        }
        
        .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
        }
        
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 价格显示样式 */
        .price-tag {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        /* 分类徽章样式 */
        .badge.fs-6 {
            font-size: 0.8rem !important;
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
        }
        
        /* 模态框样式优化 */
        .modal-content {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            border-bottom: 2px solid #f8f9fa;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem 1rem 0 0;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            .card-header h5 {
                font-size: 1rem;
            }
            
            .specifications {
                max-height: 80px;
            }
            
            .platform-tags .badge {
                font-size: 0.6rem;
                padding: 0.1rem 0.3rem;
            }
        }
        
        /* 产品搜索结果高亮 */
        .search-highlight {
            background-color: #fff3cd;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
        }
        
        /* 加载动画 */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #007bff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { currentPage: 'products', texts: texts }) %>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <h1 class="display-4 mb-4"><%= texts.products.title %></h1>
                    <p class="lead mb-4">探索我们的创新产品，为您的业务提供完整解决方案</p>
                    
                    <!-- Search Form -->
                    <div class="search-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control form-control-lg" 
                                       id="searchInput" placeholder="搜索产品..." 
                                       value="<%= currentQuery %>">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-lg" id="categoryFilter">
                                    <option value="">选择分类</option>
                                    <% categories.forEach(category => { %>
                                        <option value="<%= category %>" <%= currentCategory === category ? 'selected' : '' %>>
                                            <%= category %>
                                        </option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-lg" id="sortBy">
                                    <option value=""><%= texts.products.search.sort %></option>
                                    <option value="name">名称排序</option>
                                    <option value="category">分类排序</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col">
                                <button type="button" class="btn btn-light btn-lg" onclick="searchProducts()">
                                    <i class="fas fa-search me-2"></i><%= texts.products.search.button %>
                                </button>
                                <button type="button" class="btn btn-outline-light btn-lg clear-search" onclick="clearSearch()">
                                    <i class="fas fa-times me-2"></i><%= texts.products.search.clear %>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main class="container my-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><%= texts.nav.home %></a></li>
                <li class="breadcrumb-item active" aria-current="page"><%= texts.products.title %></li>
            </ol>
        </nav>

        <!-- Search Results Info -->
        <div class="search-stats" id="searchStats">
            <% if (hasSearchResults) { %>
                找到 <%= products.length %> 个产品
                <% if (currentQuery) { %>
                    ，关键词："<%= currentQuery %>"
                <% } %>
                <% if (currentCategory) { %>
                    ，分类："<%= currentCategory %>"
                <% } %>
            <% } else { %>
                显示全部 <%= products.length %> 个产品
            <% } %>
        </div>

        <!-- Product Grid -->
        <div class="product-grid">
            <div class="row" id="productGrid">
                
                <!-- 车载应用产品 -->
                <% products.forEach(product => { %>
                    <div class="col-md-6 col-lg-4 mb-4 product-item" 
                         data-category="<%= product.category %>" 
                         data-name="<%= product.name %>"
                         data-tags="<%= product.tags.join(',') %>">
                        <div class="card product-card h-100 shadow-sm">
                            <div class="card-header bg-transparent border-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-0 text-truncate flex-grow-1 me-2">
                                        <%= product.name %>
                                    </h5>
                                    <span class="badge fs-6 
                                        <%= product.category === '车载核心应用' ? 'bg-primary' : 
                                            product.category === 'AI智能服务' ? 'bg-warning text-dark' : 
                                            'bg-info' %>">
                                        <%= product.category %>
                                    </span>
                                </div>
                                <% if (product.price) { %>
                                    <div class="mt-2">
                                        <span class="text-success fw-bold fs-6">
                                            <i class="fas fa-tag me-1"></i><%= product.price %>
                                        </span>
                                    </div>
                                <% } %>
                            </div>
                            
                            <div class="card-body pt-0">
                                <p class="card-text text-muted small mb-3">
                                    <%= product.description.length > 120 ? 
                                        product.description.substring(0, 120) + '...' : 
                                        product.description %>
                                </p>
                                
                                <h6 class="mb-2 text-primary">
                                    <i class="fas fa-star me-1"></i>核心特性：
                                </h6>
                                <ul class="list-unstyled feature-list mb-3">
                                    <% product.features.slice(0, 4).forEach(feature => { %>
                                        <li class="small">
                                            <i class="fas fa-check-circle text-success me-2"></i><%= feature %>
                                        </li>
                                    <% }) %>
                                </ul>
                                
                                <% if (product.platforms && product.platforms.length > 0) { %>
                                    <div class="mb-3">
                                        <h6 class="mb-2 text-info">
                                            <i class="fas fa-microchip me-1"></i>支持平台：
                                        </h6>
                                        <div class="platform-tags">
                                            <% product.platforms.forEach(platform => { %>
                                                <span class="badge bg-light text-dark border small me-1 mb-1">
                                                    <%= platform %>
                                                </span>
                                            <% }) %>
                                        </div>
                                    </div>
                                <% } %>
                                
                                <% if (product.specifications) { %>
                                    <div class="mb-3">
                                        <h6 class="mb-2 text-secondary">
                                            <i class="fas fa-cogs me-1"></i>技术规格：
                                        </h6>
                                        <div class="specifications">
                                            <% Object.keys(product.specifications).slice(0, 3).forEach(key => { %>
                                                <div class="d-flex justify-content-between small text-muted border-bottom py-1">
                                                    <span class="fw-medium"><%= key %>：</span>
                                                    <span class="text-end"><%= product.specifications[key] %></span>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                <% } %>
                                
                                <div class="tag-container">
                                    <% product.tags.slice(0, 5).forEach(tag => { %>
                                        <span class="badge bg-secondary product-tag small"><%= tag %></span>
                                    <% }) %>
                                </div>
                            </div>
                            
                            <div class="card-footer bg-transparent border-0 pt-0">
                                <div class="d-grid gap-2">
                                    <button class="btn <%= product.category === '车载核心应用' ? 'btn-primary' : 
                                                          product.category === 'AI智能服务' ? 'btn-warning' : 
                                                          'btn-info' %> btn-sm" 
                                            onclick="showProductDetails('<%= product.id %>')">
                                        <i class="fas fa-info-circle me-1"></i>了解详情
                                    </button>
                                    <% if (product.category !== '技术服务') { %>
                                        <button class="btn btn-outline-success btn-sm" 
                                                onclick="requestDemo('<%= product.id %>')">
                                            <i class="fas fa-play me-1"></i>申请演示
                                        </button>
                                    <% } else { %>
                                        <button class="btn btn-outline-success btn-sm" 
                                                onclick="requestConsultation('<%= product.id %>')">
                                            <i class="fas fa-comments me-1"></i>咨询服务
                                        </button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>



            </div>
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="text-center py-5" style="display: none;">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4><%= texts.products.search.noResults %></h4>
            <p>请尝试调整搜索条件或清除筛选器</p>
        </div>

    </main>

    <%- include('../partials/footer', { texts: texts }) %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let allProducts = [];
        let filteredProducts = [];

        // 初始化产品数据
        document.addEventListener('DOMContentLoaded', function() {
            allProducts = Array.from(document.querySelectorAll('.product-item'));
            filteredProducts = [...allProducts];
            updateSearchStats();
        });

        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // 过滤产品
            filteredProducts = allProducts.filter(item => {
                const name = item.dataset.name.toLowerCase();
                const category = item.dataset.category;
                const cardText = item.textContent.toLowerCase();

                const matchesSearch = !searchTerm || name.includes(searchTerm) || cardText.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;

                return matchesSearch && matchesCategory;
            });

            // 排序
            if (sortBy === 'name') {
                filteredProducts.sort((a, b) => a.dataset.name.localeCompare(b.dataset.name, 'zh-CN'));
            } else if (sortBy === 'category') {
                filteredProducts.sort((a, b) => a.dataset.category.localeCompare(b.dataset.category, 'zh-CN'));
            }

            displayProducts();
            updateSearchStats();
        }

        function displayProducts() {
            const grid = document.getElementById('productGrid');
            const noResults = document.getElementById('noResults');

            // 隐藏所有产品
            allProducts.forEach(item => {
                item.style.display = 'none';
            });

            if (filteredProducts.length > 0) {
                // 显示匹配的产品
                filteredProducts.forEach(item => {
                    item.style.display = 'block';
                });
                noResults.style.display = 'none';
            } else {
                // 显示无结果消息
                noResults.style.display = 'block';
            }
        }

        function updateSearchStats() {
            const stats = document.getElementById('searchStats');
            if (filteredProducts.length === allProducts.length) {
                stats.textContent = `显示全部 ${allProducts.length} 个产品`;
            } else {
                stats.textContent = `找到 ${filteredProducts.length} 个产品，共 ${allProducts.length} 个`;
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('sortBy').value = '';
            
            filteredProducts = [...allProducts];
            displayProducts();
            updateSearchStats();
        }

        // 实时搜索
        document.getElementById('searchInput').addEventListener('input', function() {
            if (this.value === '') {
                clearSearch();
            }
        });

        // 分类和排序变化时自动搜索
        document.getElementById('categoryFilter').addEventListener('change', searchProducts);
        document.getElementById('sortBy').addEventListener('change', searchProducts);

        // 车载产品相关交互功能
        function showProductDetails(productId) {
            // 显示产品详情模态框或跳转到详情页
            // 可以通过AJAX获取产品详细信息
            fetch(`/api/products/${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 创建并显示产品详情模态框
                        showProductModal(data.data);
                    }
                })
                .catch(error => {
                    console.error('获取产品详情失败:', error);
                    alert('获取产品详情失败，请稍后重试');
                });
        }

        function showProductModal(product) {
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="productModalLabel">${product.name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">产品描述</h6>
                                        <p>${product.description}</p>
                                        
                                        <h6 class="text-primary mt-3">核心特性</h6>
                                        <ul>${product.features.map(f => `<li>${f}</li>`).join('')}</ul>
                                    </div>
                                    <div class="col-md-6">
                                        ${product.platforms ? `
                                            <h6 class="text-info">支持平台</h6>
                                            <div class="mb-3">
                                                ${product.platforms.map(p => `<span class="badge bg-light text-dark border me-1">${p}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        ${product.specifications ? `
                                            <h6 class="text-secondary">技术规格</h6>
                                            <table class="table table-sm">
                                                ${Object.entries(product.specifications).map(([key, value]) => 
                                                    `<tr><td>${key}</td><td>${value}</td></tr>`
                                                ).join('')}
                                            </table>
                                        ` : ''}
                                        
                                        ${product.price ? `
                                            <h6 class="text-success">价格信息</h6>
                                            <p class="fs-5 fw-bold text-success">${product.price}</p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" onclick="requestDemo('${product.id}')">申请演示</button>
                                <button type="button" class="btn btn-success" onclick="contactSales('${product.id}')">联系销售</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('productModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框并显示
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function requestDemo(productId) {
            // 申请产品演示
            const modalHtml = `
                <div class="modal fade" id="demoModal" tabindex="-1" aria-labelledby="demoModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="demoModalLabel">申请产品演示</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="demoForm">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="demoName" class="form-label">姓名 *</label>
                                        <input type="text" class="form-control" id="demoName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="demoCompany" class="form-label">公司名称 *</label>
                                        <input type="text" class="form-control" id="demoCompany" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="demoPhone" class="form-label">联系电话 *</label>
                                        <input type="tel" class="form-control" id="demoPhone" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="demoEmail" class="form-label">邮箱地址 *</label>
                                        <input type="email" class="form-control" id="demoEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="demoRequirement" class="form-label">具体需求</label>
                                        <textarea class="form-control" id="demoRequirement" rows="3" placeholder="请描述您的具体需求和应用场景"></textarea>
                                    </div>
                                    <input type="hidden" id="demoProductId" value="${productId}">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="submit" class="btn btn-primary">提交申请</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('demoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框并显示
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('demoModal'));
            modal.show();
            
            // 处理表单提交
            document.getElementById('demoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitDemoRequest();
            });
        }

        function requestConsultation(productId) {
            // 技术服务咨询申请
            const modalHtml = `
                <div class="modal fade" id="consultationModal" tabindex="-1" aria-labelledby="consultationModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="consultationModalLabel">咨询技术服务</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="consultationForm">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="consultName" class="form-label">姓名 *</label>
                                        <input type="text" class="form-control" id="consultName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="consultCompany" class="form-label">公司名称 *</label>
                                        <input type="text" class="form-control" id="consultCompany" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="consultPhone" class="form-label">联系电话 *</label>
                                        <input type="tel" class="form-control" id="consultPhone" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="consultEmail" class="form-label">邮箱地址 *</label>
                                        <input type="email" class="form-control" id="consultEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="consultProject" class="form-label">项目描述 *</label>
                                        <textarea class="form-control" id="consultProject" rows="4" placeholder="请详细描述您的项目需求、技术挑战和预期目标" required></textarea>
                                    </div>
                                    <input type="hidden" id="consultProductId" value="${productId}">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="submit" class="btn btn-info">提交咨询</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('consultationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模态框并显示
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('consultationModal'));
            modal.show();
            
            // 处理表单提交
            document.getElementById('consultationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitConsultationRequest();
            });
        }

        function submitDemoRequest() {
            const formData = {
                productId: document.getElementById('demoProductId').value,
                name: document.getElementById('demoName').value,
                company: document.getElementById('demoCompany').value,
                phone: document.getElementById('demoPhone').value,
                email: document.getElementById('demoEmail').value,
                requirement: document.getElementById('demoRequirement').value,
                type: 'demo_request'
            };
            
            fetch('/api/contact/demo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('演示申请提交成功！我们的技术专家将在24小时内与您联系。');
                    bootstrap.Modal.getInstance(document.getElementById('demoModal')).hide();
                } else {
                    alert('提交失败，请稍后重试或直接联系我们。');
                }
            })
            .catch(error => {
                console.error('提交演示申请失败:', error);
                alert('提交失败，请稍后重试或直接联系我们。');
            });
        }

        function submitConsultationRequest() {
            const formData = {
                productId: document.getElementById('consultProductId').value,
                name: document.getElementById('consultName').value,
                company: document.getElementById('consultCompany').value,
                phone: document.getElementById('consultPhone').value,
                email: document.getElementById('consultEmail').value,
                project: document.getElementById('consultProject').value,
                type: 'consultation_request'
            };
            
            fetch('/api/contact/consultation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('咨询申请提交成功！我们的技术顾问将在24小时内与您联系。');
                    bootstrap.Modal.getInstance(document.getElementById('consultationModal')).hide();
                } else {
                    alert('提交失败，请稍后重试或直接联系我们。');
                }
            })
            .catch(error => {
                console.error('提交咨询申请失败:', error);
                alert('提交失败，请稍后重试或直接联系我们。');
            });
        }

        function contactSales(productId) {
            // 联系销售 - 可以跳转到联系页面或直接拨打电话
            window.open('/contact?product=' + productId, '_blank');
        }
    </script>
</body>
</html>

