name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ä»£ç è§„èŒƒæ£€æŸ¥
      run: npm run lint
      
    - name: è¿è¡Œæµ‹è¯•
      run: npm run test:ci
      
    - name: è´¨é‡é—¨æ§æ£€æŸ¥
      run: npm run quality-check
      
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  # å®‰å…¨æ£€æŸ¥
  security-check:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: å®‰å…¨æ¼æ´æ‰«æ
      run: npm audit --audit-level=moderate
      
    - name: ä¾èµ–æ£€æŸ¥
      run: npm ls --depth=0

  # æ„å»ºéªŒè¯
  build-check:
    name: æ„å»ºéªŒè¯
    runs-on: ubuntu-latest
    needs: [quality-check, security-check]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºåº”ç”¨
      run: npm run build
      
    - name: æ„å»ºéªŒè¯
      run: |
        echo "éªŒè¯æ„å»ºäº§ç‰©..."
        ls -la
        
  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ (ä»…åœ¨developåˆ†æ”¯)
  deploy-staging:
    name: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: éƒ¨ç½²å‡†å¤‡
      run: |
        echo "å‡†å¤‡éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
        echo "éƒ¨ç½²æ—¶é—´: $(date)"
        
    - name: æ¨¡æ‹Ÿéƒ¨ç½²
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒå®Œæˆ"
        echo "è®¿é—®åœ°å€: https://staging.company-portal.com"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (ä»…åœ¨mainåˆ†æ”¯)
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç”Ÿäº§éƒ¨ç½²å‰æ£€æŸ¥
      run: |
        echo "æ‰§è¡Œç”Ÿäº§éƒ¨ç½²å‰æ£€æŸ¥..."
        echo "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
        echo "æ£€æŸ¥ç¯å¢ƒå˜é‡..."
        
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå®Œæˆ"
        echo "è®¿é—®åœ°å€: https://company-portal.com"
        
    - name: éƒ¨ç½²åéªŒè¯
      run: |
        echo "æ‰§è¡Œéƒ¨ç½²åéªŒè¯..."
        echo "å¥åº·æ£€æŸ¥é€šè¿‡ âœ…"

  # é€šçŸ¥
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: å‘é€é€šçŸ¥
      run: |
        echo "ğŸ“¢ CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ"
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"